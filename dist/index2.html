<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vehicle Dashboard Gesture Control</title>

    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <div class="container">
        <div id="header" class="row">
            <div class="col-md-2 col-xs-4" id="images">
                <img src="block-s.png" height="48" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <img src="CorporateLogoSmall.png" height="50" />
            </div>
            <div class="col-md-10 col-xs-4" id="header-title">Project 4: Vehicle Dashboard Gesture Control</div>
        </div>
        <div class="row">
            <div class="col-md-10" id="title">
                Dashboard
            </div>
            <div class="col-md-2" id="reload">
                <input type="button" value="Reload Page" onclick="window.location.reload()">
            </div>
        </div>


        <div class="data-triggers">
            <div class="row">
                <div class="col-md-2 col-xs-4">
                    <div class="data-title status">Gestures:</div>
                </div>
                <div class="col-md-2 col-xs-4">
                    <div class="status">
                        <div class="status-title" id="status-1">Clockwise Circle:<br />Volume Up</div>
                        <!--<div class="status-icon" id="status-icon-1"></div>-->
                    </div>
                </div>
                <div class="col-md-2 col-xs-4">
                    <div class="status">
                        <div class="status-title" id="status-2">Swipe Right:<br />Seek Up/Next Track</div>
                        <!--<div class="status-icon" id="status-icon-2"></div>-->
                    </div>
                </div>
                <div class="col-md-2 col-xs-4">
                    <div class="status">
                        <div class="status-title" id="status-3">Swipe Up:<br />Headlights On/High</div>
                        <!--<div class="status-icon" id="status-icon-3"></div>-->
                    </div>
                </div>
                <div class="col-md-2 col-xs-4">
                    <div class="status">
                        <div class="status-title" id="status-4">Point Right:<br />Right Turn Signal</div>
                        <!--<div class="status-icon" id="status-icon-4"></div>-->
                    </div>
                </div>
                <div class="col-md-2 col-xs-4">
                    <div class="status">
                        <div class="status-title" id="status-11">Grab &amp; Slide:<br />Dimmer Control</div>
                        <!--<div class="status-icon" id="status-icon-11"></div>-->
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-2 col-xs-4">
                    <div class="status">
                        <div class="status-title" id="status-5">Screen Tap:<br />Radio Source</div>
                        <!--<div class="status-icon" id="status-icon-5"></div>-->
                    </div>
                </div>
                <div class="col-md-2 col-xs-4">
                    <div class="status">
                        <div class="status-title" id="status-7">Counterclockwise Circle:<br />Volume Down</div>
                        <!--<div class="status-icon" id="status-icon-7"></div>-->
                    </div>
                </div>
                <div class="col-md-2 col-xs-4">
                    <div class="status">
                        <div class="status-title" id="status-8">Swipe Left:<br />Seek Down/Previous Track</div>
                        <!--<div class="status-icon" id="status-icon-8"></div>-->
                    </div>
                </div>
                <div class="col-md-2 col-xs-4">
                    <div class="status">
                        <div class="status-title" id="status-9">Swipe Down:<br />Headlights Low/Off</div>
                        <!--<div class="status-icon" id="status-icon-9"></div>-->
                    </div>
                </div>
                <div class="col-md-2 col-xs-4">
                    <div class="status">
                        <div class="status-title" id="status-10">Point Left:<br />Left Turn Signal</div>
                        <!--<div class="status-icon" id="status-icon-10"></div>-->
                    </div>
                </div>
                <div class="col-md-2 col-xs-4">
                    <div class="status">
                        <div class="status-title" id="status-12">N.C. State<br />Go Wolfpack!</div>
                        <!--<div class="status-icon" id="status-icon-12"></div>-->
                        <div id="sound">
                            <audio controls loop id="audio" style="display:none">
                                <source src="NC_State__Hey_Cheer.mp3" type="audio/mpeg" />
                                Your browser doesn't support this audio format.
                            </audio>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="data-container">
            <div class="row">
                <div class="col-md-7">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="data-title">Frame Data:</div>
                        </div>
                        <div class="col-md-10">
                            <div class="pointable" id="frameData"></div>
                        </div>
                    </div>
                    <div class="data-title">Gesture Data:</div>
                    <div id="gestureData"></div>
                    <div class="data-title">Arduino Console:</div>
                    <div id="console"><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /></div>
                </div>
                <div class="col-md-5">
                    <div class="data-title">Hand Data:</div>
                    <div class="row" id="handData"></div>
                    <div class="data-title">Finger Data:</div>
                    <div class="row" id="pointableData"></div>
                </div>
            </div>
        </div>
        <div id="title"><div id="footer">a</div></div>
        <div id="header"><div id="footer"><img src="ncsu.png" /></div></div>
    </div>
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>-->
    <!--<script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>-->
    <script src="/socket.io/socket.io.js"></script>
    <!--<script src="http://js.leapmotion.com/leap-0.6.1.min.js"></script>-->

    <script src="jquery.min.js"></script>
    <script src="bootstrap.min.js"></script>
    <script src="leap-0.6.1.min.js"></script>

    <script>


        // The socket set up.
        var socket = io.connect('http://localhost:8080');

        socket.on('news', function (data) {
            console.log(data);
        });

        socket.on('console', function (data) {
            var console = document.getElementById("console");
            consoleString = consoleString.substring(consoleString.indexOf("<br/>") + 5) + "<br/>&gt; " + data.text;
            console.innerHTML = consoleString;
        });

        var audio = document.getElementById('audio');
        audio.pause();

        var controllerOptions = { enableGestures: true };
        var previousFrame = null;
        var inGesture = false;
        var inDebounce = false;
        var turnGesture = false;
        var timer = 10;
        var turnTimer = 300;
        var inGrabState = false;

        var consoleString = "<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>";

        Leap.loop(controllerOptions, function (frame) {
            if (inDebounce) { // Screen Tap debounce, allows wire to be high long enough to read.
                if (timer-- <= 0) {
                    timer = 10;
                    inDebounce = false;
                    inGesture = false;
                    socket.emit('gesture', { gestureOff: true });
                }
            } else {
                $('#status-5').css("border-color", "#9698A9");
                $('#status-6').css("border-color", "#9698A9");
            }
            if (inGesture && frame.gestures.length == 0) { // Wait for gesture data to be flushed before tracking again.
                inGesture = false;
                socket.emit('gesture', { gestureOff: true });
            }

            if (turnGesture) { // Separate Turn Signal debounce, allows other gestures to continue to work.
                if (turnTimer-- <= 0) {
                    turnTimer = 300;
                    turnGesture = false;
                    socket.emit('gesture', { turnOff: true }); //#5D646C
                    $('#status-4').css("border-color", "#9698A9");
                    $('#status-10').css("border-color", "#9698A9");
                }
            }

// Display Frame object data
            var frameOutput = document.getElementById("frameData");

            // Time tracking
            var seconds = Math.floor((frame.timestamp / 1000000) % 60);
            var minutes = parseInt((frame.timestamp / 1000000) / 60) % 60;
            var hours = parseInt((frame.timestamp / 1000000) / 3600) % 24;

            var frameString = "Frame ID: " + frame.id + " | Timestamp: " + hours + "h " + minutes + "m " + seconds + "s | Hands: " + frame.hands.length + " | Fingers: " + frame.fingers.length + " | Gestures: " + frame.gestures.length;
            frameOutput.innerHTML = frameString;

            // Frame motion factors
            if (previousFrame && previousFrame.valid) {
                var translation = frame.translation(previousFrame);
            }
            

// Display Hand object data
            var handOutput = document.getElementById("handData");
            var handString = "";
            if (frame.hands.length > 0) {
                for (var i = 0; i < 2; i++) {
                    handString += "<div class='col-md-6'><div class='pointable'>";
                    if (i < frame.hands.length) {
                        var hand = frame.hands[i];
                        handString += "ID: " + hand.id + "<br />";
                        handString += "Type: " + hand.type + " hand" + "<br />";
                        handString += "Direction: " + vectorToString(hand.direction, 2) + "<br />";
                        handString += "Palm Position: " + vectorToString(hand.palmPosition, 0) + "<br />";
                        // Hand motion factors
                        if (previousFrame && previousFrame.valid) {
                            var translation = hand.translation(previousFrame);
                            handString += "Translation: " + vectorToString(translation, 0) + "<br />";
                            var rotationAxis = hand.rotationAxis(previousFrame, 2);
                            var rotationAngle = hand.rotationAngle(previousFrame);
                            handString += "Rotation Axis: " + vectorToString(rotationAxis) + "<br />";
                            handString += "Rotation Angle: " + rotationAngle.toFixed(2) + " radians<br />";
                            var scaleFactor = hand.scaleFactor(previousFrame);
                        }
                        handString += "Grab Strength: " + hand.grabStrength + "<br />";
                        handString += "Pinch Strength: " + hand.pinchStrength + "<br />";

                        // Pointing Gestures
                        if ((hand.direction[0] > .6) && hand.indexFinger.extended && (hand.pinchStrength >= .6 || hand.grabStrength >= .5)) { // Right Point
                            $('#status-4').css("border-color", "#CC0000");
                            if (hand.type == "right" && frame.gestures.length <= 0 && !turnGesture) {
                                turnGesture = true;
                                inDebounce = true;
                                socket.emit('gesture', { turnRight: true });
                            }
                        } else if ((hand.direction[0] < -.4) && hand.indexFinger.extended && (hand.pinchStrength >= .6 || hand.grabStrength >= .5)) { // Left Point
                            $('#status-10').css("border-color", "#CC0000");
                            if (hand.type == "right" && frame.gestures.length <= 0 && !turnGesture) {
                                turnGesture = true;
                                inDebounce = true;
                                socket.emit('gesture', { turnLeft: true });
                            }
                        } else {
                            $('#status-4').css("border-color", "#9698A9");
                            $('#status-10').css("border-color", "#9698A9");
                        }

                        // Wolf Ears
                        if ((hand.pinchStrength > .6) && hand.indexFinger.extended && hand.pinky.extended) {
                            $("#status-12").css("border-color", "#CC0000");
                            if (audio.paused)
                                audio.play();
                        } else {
                            $("#status-12").css("border-color", "#9698A9");
                            //if (!audio.paused) {
                            audio.pause();
                            audio.currentTime = 0;
                            //}
                        }

                        // Send a message to the socket when grab triggered.
                        if (hand.grabStrength == 1) {
                            //handString += "<div style='color:red'>" + "The grab strength is greater than 0.8" + "</div>";
                            $("#status-11").css("border-color", "#CC0000");
                            if (inGrabState) {
                                if (hand.type == "right" && (Math.abs(translation[0]) < 1 || Math.abs(translation[2]) < 1))
                                    socket.emit('dimmer', { dimmerChange: translation[1].toFixed(0) });
                            } else {
                                inGrabState = true;
                                if (hand.type == "right")
                                    socket.emit('gesture', { grabState: true });
                            }
                        } else {
                            $("#status-11").css("border-color", "#9698A9");
                            if (inGrabState && hand.type == "right")
                                socket.emit('gesture', { grabOff: true });
                            inGrabState = false;
                        }
                    } else {
                        handString += "<br/><br/><br/><br/><br/><br/><br/><br/><br/>";
                    }
                    handString += "</div></div>";
                }
            } else {
                handString += "<div class='col-md-6'><div class='pointable'>No Hands<br/><br/><br/><br/><br/><br/><br/><br/><br/></div></div>"
                            + "<div class='col-md-6'><div class='pointable'><br/><br/><br/><br/><br/><br/><br/><br/><br/></div></div>";
                $("#status-11").css("border-color", "#9698A9");
            }
            handOutput.innerHTML = handString;

// Display Pointable (finger and tool) object data
            var pointableOutput = document.getElementById("pointableData");
            var pointableString = "<div class='col-md-6'>";
            if (frame.pointables.length > 0) {
                var fingerTypeMap = ["Thumb", "Index Finger", "Middle Finger", "Ring Finger", "Pinky Finger"];
                for (var i = 0; i < 10; i++) {
                    pointableString += "<div class='pointable'>";
                    if (i < frame.pointables.length) {
                        var pointable = frame.pointables[i];
                        pointableString += "Type: " + fingerTypeMap[pointable.type] + "<br />";
                        pointableString += "ID: " + pointable.id + "<br />";
                        pointableString += "Direction: " + vectorToString(pointable.direction, 2) + "<br />";
                        pointableString += "Tip Position: " + vectorToString(pointable.tipPosition, 0) + "<br />";
                        if (pointable.extended)
                            pointableString += "Is Extended<br/>";
                        else
                            pointableString += "Not Extended<br/>"
                    } else {
                        pointableString += "<br/><br/><br/><br/><br/>";
                    }
                    pointableString += "</div>";
                    if (i == 4) pointableString += "</div><div class='col-md-6'>";
                }
                pointableString += "</div>";
            } else {
                pointableString += "<div class='pointable'>No Fingers<br/><br/><br/><br/><br/></div><div class='pointable'><br/><br/><br/><br/><br/></div><div class='pointable'><br/><br/><br/><br/><br/></div><div class='pointable'><br/><br/><br/><br/><br/></div><div class='pointable'><br/><br/><br/><br/><br/></div></div>"
                    + "<div class='col-md-6'><div class='pointable'><br/><br/><br/><br/><br/></div><div class='pointable'><br/><br/><br/><br/><br/></div><div class='pointable'><br/><br/><br/><br/><br/></div><div class='pointable'><br/><br/><br/><br/><br/></div><div class='pointable'><br/><br/><br/><br/><br/></div></div>";
            }
            pointableOutput.innerHTML = pointableString;

// Display Gesture object data
            var gestureOutput = document.getElementById("gestureData");
            var gestureString = "<div class='pointable'>";
            if (frame.gestures.length > 0) {
                for (var i = 0; i < 20; i++) {
                    if (i < frame.gestures.length) {
                        var gesture = frame.gestures[i];
                        gestureString += "ID: " + gesture.id + ", "
                                + "Type: " + gesture.type + ", "
                                + "State: " + gesture.state + ", "
                                + "Hand: " + gesture.handIds.join(", ") + ", "
                                + "Finger: " + gesture.pointableIds.join(", ") + ", "
                                + "Duration: " + (gesture.duration/1000000).toFixed(2) + " s, ";

                        switch (gesture.type) {
                            case "circle":
                                gestureString += "Direction: ";

                                // Calculate the direction of the circle.
                                var clockwise = false;
                                var pointableID = gesture.pointableIds[0];
                                var direction = frame.pointable(pointableID).direction;
                                var dotProduct = Leap.vec3.dot(direction, gesture.normal);
                                if (dotProduct > 0) clockwise = true;

                                // Count how many completed circles the user drew.
                                var circleProgress = gesture.progress;
                                var completeCircles = Math.floor(circleProgress);

                                // Send message to the socket depending on the direction of the circle and circle counts.
                                if (clockwise) {
                                    gestureString += "CC, ";
                                    $('#status-1').css("border-color", "#CC0000");
                                    if (!inGesture) {
                                        if (gesture.progress >= 1 && gesture.progress < 2) {
                                            inGesture = true;
                                            socket.emit('gesture', { cwCircle: true });
                                        }
                                    }
                                } else {
                                    gestureString += "CCW, ";
                                    $('#status-7').css("border-color", "#CC0000");
                                    if (!inGesture) {
                                        if (gesture.progress >= 1 && gesture.progress < 2) {
                                            inGesture = true;
                                            socket.emit('gesture', { ccwCircle: true });
                                        }
                                    }
                                }
                                gestureString += "Rotations: " + gesture.progress.toFixed(2);
                                break;
                            case "swipe":
                                gestureString += "Direction: ";
                                //Classify swipe as either horizontal or vertical
                                var isHorizontal = Math.abs(gesture.direction[0]) > Math.abs(gesture.direction[1]);
                                //Classify as right-left or up-down
                                if (isHorizontal) {
                                    if (gesture.direction[0] > 0) { // Right
                                        gestureString += "Right";
                                        $('#status-2').css("border-color", "#CC0000");
                                        if (!inGesture) {
                                            if (gesture.state == "start") {
                                                inGesture = true;
                                                socket.emit('gesture', { swipeRight: true });
                                            }
                                        }
                                    } else { // Left
                                        gestureString += "Left";
                                        $('#status-8').css("border-color", "#CC0000");
                                        if (!inGesture) {
                                            if (gesture.state == "start") {
                                                inGesture = true;
                                                socket.emit('gesture', { swipeLeft: true });
                                            }
                                        }
                                    }
                                } else { //vertical
                                    if (gesture.direction[1] > 0) { // Up
                                        gestureString += "Up";
                                        $('#status-3').css("border-color", "#CC0000");
                                        if (!inGesture && hand.type == "right") {
                                            if (gesture.state == "start") {
                                                inGesture = true;
                                                socket.emit('gesture', { swipeUp: true });
                                            }
                                        }
                                    } else { // Down
                                        gestureString += "Down";
                                        $('#status-9').css("border-color", "#CC0000");
                                        if (!inGesture && hand.type == "right") {
                                            if (gesture.state == "start") {
                                                inGesture = true;
                                                socket.emit('gesture', { swipeDown: true });
                                            }
                                        }
                                    }
                                }
                                break;
                            case "screenTap":
                                $('#status-5').css("border-color", "#CC0000");
                                gestureString += "Position: " + vectorToString(gesture.position, 0);
                                if (!inGesture) {
                                    socket.emit('gesture', { screenTap: true });
                                    inDebounce = true;
                                }
                                break;
                            case "keyTap":
                                break;
                            default:
                                gestureString += "unkown gesture type";
                        }
                    }
                    gestureString += "<br />";
                }
                gestureString += "</div>"
            } else {
                gestureString += "No gestures<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/></div>";

                $('#status-1').css("border-color", "#9698A9");
                $('#status-2').css("border-color", "#9698A9");
                $('#status-3').css("border-color", "#9698A9");
                $('#status-7').css("border-color", "#9698A9");
                $('#status-8').css("border-color", "#9698A9");
                $('#status-9').css("border-color", "#9698A9");

            }
            gestureOutput.innerHTML = gestureString;
            previousFrame = frame;
        });

        // Converting the vector to a string function.
        function vectorToString(vector, digits) {
            if (typeof digits === "undefined") {
                digits = 1;
            }
            return "(" + vector[0].toFixed(digits) + ", "
                    + vector[1].toFixed(digits) + ", "
                    + vector[2].toFixed(digits) + ")";
        }
    </script>
</body>
</html>
